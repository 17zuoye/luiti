<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Luiti by 17zuoye</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Luiti</h1>
      <h2 class="project-tagline">luiti = luigi + time.</h2>
      <a href="https://github.com/17zuoye/luiti" class="btn">View on GitHub</a>
      <a href="https://github.com/17zuoye/luiti/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/17zuoye/luiti/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="luiti" class="anchor" href="#luiti" aria-hidden="true"><span class="octicon octicon-link"></span></a>Luiti</h1>

<p><a href="https://travis-ci.org/17zuoye/luiti"><img src="https://img.shields.io/travis/17zuoye/luiti/master.svg?style=flat" alt="Build Status"></a>
<a href="https://coveralls.io/r/17zuoye/luiti"><img src="https://coveralls.io/repos/17zuoye/luiti/badge.svg" alt="Coverage Status"></a>
<a href="https://landscape.io/github/17zuoye/luiti/master"><img src="https://landscape.io/github/17zuoye/luiti/master/landscape.svg?style=flat" alt="Health"></a>
<a href="https://pypi.python.org/pypi/luiti"><img src="https://img.shields.io/pypi/dm/luiti.svg?style=flat" alt="Download"></a>
<a href="https://pypi.python.org/pypi/luiti"><img src="https://img.shields.io/pypi/l/luiti.svg?style=flat" alt="License"></a>
<a href="https://pypi.python.org/pypi/luiti"><img src="https://pypip.in/py_versions/luiti/badge.svg?style=flat" alt="Python Versions"></a></p>

<p>As <a href="https://github.com/spotify/luigi">Luigi</a>'s homepage said, it's "a
Python module that helps you build complex pipelines of batch jobs. It
handles dependency resolution, workflow management, visualization etc.
It also comes with Hadoop support built in."</p>

<p>Luiti is built on top of Luigi, separates all your tasks into multiple
packages, and forces one task per one Python file. Luiti task classes
can be managed by the <code>luiti</code> command, supported operations are ls, new,
generate, info, clean, and run.</p>

<p>Luiti is born to build a layered database structure, corresponding to
the different packages we just mentioned. A data warehouse is consisted
of synced data sources, fact tables, dimension tables, regular or
temporary business reports.</p>

<p>The essence of batching processing system is to separating a large task
into small tasks, and the essence of business report is that a daily
report or a weekly report is requried, so here comes TaskDay, TaskWeek,
and more. Task classes also have a Hadoop version, such as TaskDayHadoop,
TaskWeekHadoop, and so on.</p>

<p>You can pass any parameters into Luigi's tasks, but Luiti recommend you
to pass only <code>date_value</code> parameter. So you can run Luiti tasks
periodically, e.g. hourly, daily, weekly, etc. luiti = luigi + time.</p>

<h2>
<a id="document-guide" class="anchor" href="#document-guide" aria-hidden="true"><span class="octicon octicon-link"></span></a>Document guide</h2>

<ol>
<li><a href="#luiti">Intro</a></li>
<li><a href="#luiti-command-tool">Luiti command tool</a></li>
<li><a href="#luiti-webui-screenshots">Luiti WebUI screenshots</a></li>
<li><a href="#core-concepts-based-on-time-management">Core concepts based on time management</a></li>
<li><a href="#task-specification-and-built-in-properties-and-recommendation">Task specification and built-in properties and recommendation</a></li>
<li><a href="#manage-multiple-projects-in-luiti">Manage multiple projects in luiti</a></li>
<li><a href="#a-simple-guide-to-luigi">A simple guide to Luigi</a></li>
<li><a href="#a-simple-example-in-luiti">A simple example in luiti</a></li>
<li><a href="#install">Install</a></li>
<li><a href="#task-recommendation">Task recommendation</a></li>
<li><a href="#task-decorators">Task decorators</a></li>
<li><a href="#mapreduce-related">MapReduce related</a></li>
<li><a href="#extend-luiti">Extend luiti</a></li>
<li><a href="#faq">FAQ</a></li>
<li><a href="#run-tests">Run tests</a></li>
<li><a href="#who-uses-luiti">Who uses Luiti?</a></li>
</ol>

<h2>
<a id="luiti-command-tool" class="anchor" href="#luiti-command-tool" aria-hidden="true"><span class="octicon octicon-link"></span></a>Luiti command tool</h2>

<p>After installed package, you can use <code>luiti</code> command tool that contained
in the package.</p>

<pre lang="text"><code>$ luiti
usage: luiti [-h] {ls,new,generate,info,clean,run,webui} ...

Luiti tasks manager.

optional arguments:
  -h, --help            show this help message and exit

subcommands:
  valid subcommands

  {ls,new,generate,info,clean,run,webui}
    ls                  list all current luiti tasks.
    new                 create a new luiti project.
    generate            generate a new luiti task python file.
    info                show a detailed task.
    clean               manage files that outputed by luiti tasks.
    run                 run a luiti task.
    webui               start a luiti DAG visualiser.
</code></pre>

<h2>
<a id="luiti-webui-screenshots" class="anchor" href="#luiti-webui-screenshots" aria-hidden="true"><span class="octicon octicon-link"></span></a>Luiti WebUI screenshots</h2>

<div class="highlight highlight-bash"><pre>./example_webui_run.py
<span class="pl-c"># or</span>
luiti webui --project-dir your_main_luiti_package_path</pre></div>

<p>Here's some screenshots from example_webui_run.py, just to give you an
idea of how luiti's multiple Python packages works.</p>

<ol>
<li><p>Luiti WebUI list
<img src="https://raw.githubusercontent.com/17zuoye/luiti/master/screenshots/luiti_webui_list.png" alt="Luiti WebUI list"></p></li>
<li><p>Luiti WebUI show
<img src="https://raw.githubusercontent.com/17zuoye/luiti/master/screenshots/luiti_webui_show.png" alt="Luiti WebUI show"></p></li>
<li><p>Luiti Code show
<img src="https://raw.githubusercontent.com/17zuoye/luiti/master/screenshots/luiti_code_show.png" alt="Luiti Code show"></p></li>
</ol>

<h2>
<a id="core-concepts-based-on-time-management" class="anchor" href="#core-concepts-based-on-time-management" aria-hidden="true"><span class="octicon octicon-link"></span></a>Core concepts based on time management</h2>

<h3>
<a id="date-type" class="anchor" href="#date-type" aria-hidden="true"><span class="octicon octicon-link"></span></a>date type</h3>

<h4>
<a id="basic-inheriting-task-classes" class="anchor" href="#basic-inheriting-task-classes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basic inheriting task classes:</h4>

<ol>
<li>TaskBase           (luigi.Task)</li>
<li>TaskHour           (TaskBase)</li>
<li>TaskDay            (TaskBase)</li>
<li>TaskWeek           (TaskBase)</li>
<li>TaskMonth          (TaskBase)</li>
<li>TaskRange          (TaskBase)</li>
</ol>

<p>You can extend more date type by subclass <code>TaskBase</code>, and make sure the
date types are added in <code>TaskBase.DateTypes</code> too.</p>

<h4>
<a id="hadoop-ineriting-task-classes" class="anchor" href="#hadoop-ineriting-task-classes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hadoop ineriting task classes:</h4>

<ol>
<li>TaskDayHadoop      (luigi.hadoop.HadoopExt, TaskDay)</li>
<li>TaskWeekHadoop     (luigi.hadoop.HadoopExt, TaskWeek)</li>
<li>TaskRangeHadoop    (luigi.hadoop.HadoopExt, TaskRange)</li>
</ol>

<h4>
<a id="other-task-classes" class="anchor" href="#other-task-classes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Other task classes:</h4>

<ol>
<li>RootTask           (luigi.Task)</li>
<li>StaticFile         (luigi.Task)</li>
<li>MongoImportTask    (TaskBase)  # export json file from hdfs to mongodb.</li>
</ol>

<h2>
<a id="task-specification-and-built-in-properties-and-recommendation" class="anchor" href="#task-specification-and-built-in-properties-and-recommendation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Task specification and built-in properties and recommendation</h2>

<h3>
<a id="task-naming-conventions" class="anchor" href="#task-naming-conventions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Task naming conventions</h3>

<ol>
<li>One Task class per file.</li>
<li>Task class should be camel case ( e.g. <code>EnglishStudentAllExamWeek</code>), file name should be low case with underscore ( e.g.  <code>english_student_all_exam_week.py</code> ).</li>
<li>Task files should be under the directory of <code>luiti_tasks</code>. luiti use this convertion to linking tasks inner and outer of pacakges.</li>
<li>Task class name should be ended with date type, e.g. Day, Week, etc.  Please refer to <code>TaskBase.DateTypes</code>.</li>
</ol>

<h3>
<a id="task-builtin-properties" class="anchor" href="#task-builtin-properties" aria-hidden="true"><span class="octicon octicon-link"></span></a>Task builtin properties.</h3>

<ol>
<li>
<code>date_value</code>. Required, even it's a Range type Task. This ensure that <code>output</code> will be written to a day directory.</li>
<li>
<code>data_file</code>. The absolute output file path, it's a string format.</li>
<li>
<code>data_dir</code>. The directory of the absolute output file path, it's a string format.</li>
<li>
<code>root_dir</code>. The root path of this package. <code>data_file</code> and <code>data_dir</code> are all under it.</li>
<li>
<code>output</code>. Basic Task's output class is LocalTarget, and Hadoop Task's output class is hdfs.HdfsTarget.</li>
<li>
<code>date_str</code>. A datetime string, such as "20140901".</li>
<li>
<code>date_type</code>. A string that generated from task class name, e.g. Day, Week, etc.</li>
<li>
<code>date_value_by_type_in_last</code>. If current date type is Week, and it'll return the previous week's <code>date_value</code>.</li>
<li>
<code>date_value_by_type_in_begin</code>. If current date type is Week, and it'll return Monday zero clock in the current week.</li>
<li>
<code>date_value_by_type_in_end</code>. If current date type is Week, and it'll return Sunday 11:59:59 clock in the current week.</li>
<li>
<code>pre_task_by_self</code>. Usually it returns previous task in the current date type. If reaches the time boundary of current date type, it returns RootTask.</li>
<li>
<code>is_reach_the_edge</code>. It's semester at 17zuoye business.</li>
<li>
<code>instances_by_date_range</code>. Class function, return all task intances list that belongs to current date range.</li>
<li>
<code>task_class</code>. Return current task class.</li>
</ol>

<h2>
<a id="manage-multiple-projects-in-luiti" class="anchor" href="#manage-multiple-projects-in-luiti" aria-hidden="true"><span class="octicon octicon-link"></span></a>Manage multiple projects in luiti</h2>

<h4>
<a id="the-directory-structure-of-a-specific-project" class="anchor" href="#the-directory-structure-of-a-specific-project" aria-hidden="true"><span class="octicon octicon-link"></span></a>The directory structure of a specific project.</h4>

<p>We recommend you to organize every project's directory structure as the
below form, and it means it's also a normal Python package, for example:</p>

<pre lang="text"><code>project_A                                            --- project directory
  setup.py                                           --- Python package install script
  README.markdown                                    --- project README
  project_A/                                         --- Python package install directory
  ├── __init__.py                                    --- mark current directories on disk as a Python package directories
  └── luiti_tasks                                    --- a directory name which indicates it contains several luiti tasks
      ├── __init__.py                                --- mark current directories on disk as a Python package directories
      ├── __init_luiti.py                            --- initialize luiti environment variables
      ├── exam_logs_english_app_day.py               --- an example luiti task
      ├── ..._day.py                                 --- another example luiti task
      └── templates                                  --- some libraries
            ├── __init__.py
            └── ..._template.py
</code></pre>

<p>After installing <code>luiti</code>, you can run following command line to generate
a project like above.</p>

<div class="highlight highlight-bash"><pre>luiti new --project-name project_A</pre></div>

<p>If other luiti projects needs to using this package, and you need to
install this package, to make sure luiti could find them in the
search path (<code>sys.path</code>) of Python modules.</p>

<h4>
<a id="how-to-link-current-task-to-another-task-that-belongs-to-another-pacakge" class="anchor" href="#how-to-link-current-task-to-another-task-that-belongs-to-another-pacakge" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to link current Task to another Task that belongs to another pacakge?</h4>

<p>Every luiti projects share the same structure, e.g.
<code>project_A/luiti_tasks/another_feature_day.py</code>. After config
<code>luigi.plug_packages("project_B", "project_C==0.0.2"])</code> in
<code>__init_luiti.py</code>, you can use <code>@luigi.ref_tasks("ArtistStreamDay')</code> to
indicate current Task to find <code>ArtistStreamDay</code> Task in current package
<code>project_A</code>, or related <code>project_B</code>, <code>project_C</code> packages.</p>

<h2>
<a id="a-simple-guide-to-luigi" class="anchor" href="#a-simple-guide-to-luigi" aria-hidden="true"><span class="octicon octicon-link"></span></a>A simple guide to Luigi</h2>

<p>Luigi's core concept is forcing you separting a big task into many small
tasks, and they're linked by atomic Input and Ouput. Luigi contains four
parts mainly:</p>

<ol>
<li>
<strong>Output</strong>. It must be implemented in <code>output</code> function, such as <code>LocalTarget</code> and <code>hdfs.HdfsTarget</code>.</li>
<li>
<strong>Input</strong>. It must be implemented in <code>requires</code> function, and the
function supposed to return some or None task instances.</li>
<li>
<strong>Parameters</strong>. Parameters should be inherited from <code>luigi.Parameter</code>,
e.g. <code>DateParameter</code>, etc.</li>
<li>
<strong>Execute Logic</strong>. Use <code>run</code> function if running at local, or <code>mapper</code> and <code>reducer</code>
if running on a distributed MapReduce YARN.</li>
</ol>

<p>After finish the business logic implementation and test cases, You can
submit your task to the <code>luigid</code> background daemon. <code>luigid</code> will
process task dependencies automatically, this is done by checking
<code>output</code> is already <code>exists</code> (It's the Target class's function). And
luigi will guarantee that task instances are uniq in current
<code>luigid</code> background process by the task class name and parameters.</p>

<h2>
<a id="a-simple-example-in-luiti" class="anchor" href="#a-simple-example-in-luiti" aria-hidden="true"><span class="octicon octicon-link"></span></a>A simple example in luiti</h2>

<h4>
<a id="an-official-example-from-luigi" class="anchor" href="#an-official-example-from-luigi" aria-hidden="true"><span class="octicon octicon-link"></span></a>An official example from luigi.</h4>

<p>Below code is copied from <a href="http://luigi.readthedocs.org/en/latest/example_top_artists.html">http://luigi.readthedocs.org/en/latest/example_top_artists.html</a></p>

<div class="highlight highlight-python"><pre><span class="pl-k">import</span> luigi
<span class="pl-k">from</span> collections <span class="pl-k">import</span> defaultdict

<span class="pl-k">class</span> <span class="pl-en">AggregateArtists</span>(<span class="pl-e">luigi.Task</span>):
    date_interval <span class="pl-k">=</span> luigi.DateIntervalParameter()

    <span class="pl-k">def</span> <span class="pl-en">output</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> luigi.LocalTarget(<span class="pl-s"><span class="pl-pds">"</span>/data/artist_streams_<span class="pl-c1">%s</span>.tsv<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-v">self</span>.date_interval)

    <span class="pl-k">def</span> <span class="pl-en">requires</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> [Streams(date) <span class="pl-k">for</span> date <span class="pl-k">in</span> <span class="pl-v">self</span>.date_interval]

    <span class="pl-k">def</span> <span class="pl-en">run</span>(<span class="pl-smi">self</span>):
        artist_count <span class="pl-k">=</span> defaultdict(<span class="pl-c1">int</span>)

        <span class="pl-k">for</span> <span class="pl-c1">input</span> <span class="pl-k">in</span> <span class="pl-v">self</span>.input():
            <span class="pl-k">with</span> <span class="pl-c1">input</span>.open(<span class="pl-s"><span class="pl-pds">'</span>r<span class="pl-pds">'</span></span>) <span class="pl-k">as</span> in_file:
                <span class="pl-k">for</span> line <span class="pl-k">in</span> in_file:
                    timestamp, artist, track <span class="pl-k">=</span> line.strip().split()
                    artist_count[artist] <span class="pl-k">+=</span> <span class="pl-c1">1</span>

        <span class="pl-k">with</span> <span class="pl-v">self</span>.output().open(<span class="pl-s"><span class="pl-pds">'</span>w<span class="pl-pds">'</span></span>) <span class="pl-k">as</span> out_file:
            <span class="pl-k">for</span> artist, count <span class="pl-k">in</span> artist_count.iteritems():
                <span class="pl-k">print</span> <span class="pl-k">&gt;&gt;</span> out_file, artist, count</pre></div>

<h4>
<a id="the-same-example-written-in-luiti" class="anchor" href="#the-same-example-written-in-luiti" aria-hidden="true"><span class="octicon octicon-link"></span></a>The same example written in luiti.</h4>

<ul>
<li>First file: <code>artist_project/luiti_tasks/artist_stream_day.py</code>
</li>
</ul>

<div class="highlight highlight-python"><pre><span class="pl-k">from</span> luiti <span class="pl-k">import</span> <span class="pl-k">*</span>

<span class="pl-k">class</span> <span class="pl-en">ArtistStreamDay</span>(<span class="pl-e">StaticFile</span>):

    <span class="pl-en">@cached_property</span>
    <span class="pl-k">def</span> <span class="pl-en">filepath</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> TargetUtils.hdfs(<span class="pl-s"><span class="pl-pds">"</span>/tmp/streams_<span class="pl-c1">%s</span>.tsv<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-v">self</span>.date_str</pre></div>

<ul>
<li>Second file: <code>artist_project/luiti_tasks/aggregate_artists_week.py</code>
</li>
</ul>

<div class="highlight highlight-python"><pre><span class="pl-k">from</span> luiti <span class="pl-k">import</span> <span class="pl-k">*</span>

<span class="pl-en">@</span><span class="pl-en">luigi.ref_tasks</span>(<span class="pl-s"><span class="pl-pds">"</span>ArtistStreamDay')<span class="pl-ii"></span></span>
<span class="pl-k">class</span> <span class="pl-en">AggregateArtistsWeek</span>(<span class="pl-e">TaskWeek</span>):

    <span class="pl-k">def</span> <span class="pl-en">requires</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> [<span class="pl-v">self</span>.ArtistStreamDay(d1) <span class="pl-k">for</span> d1 <span class="pl-k">in</span> <span class="pl-v">self</span>.days_in_week]

    <span class="pl-k">def</span> <span class="pl-en">output</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> TargetUtils.hdfs(<span class="pl-s"><span class="pl-pds">"</span>/data/artist_streams_<span class="pl-c1">%s</span>.tsv<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-v">self</span>.date_str

    <span class="pl-k">def</span> <span class="pl-en">run</span>(<span class="pl-smi">self</span>):
        <span class="pl-smi">artist_count</span> <span class="pl-k">=</span> defaultdict(<span class="pl-c1">int</span>)

        <span class="pl-k">for</span> file1 <span class="pl-k">in</span> <span class="pl-v">self</span>.input():
            <span class="pl-k">for</span> line2 <span class="pl-k">in</span> TargetUtils.line_read(file1):
                timestamp, artist, <span class="pl-smi">track</span> <span class="pl-k">=</span> line.strip().split()
                artist_count[artist] <span class="pl-k">+=</span> <span class="pl-c1">1</span>

        <span class="pl-k">with</span> <span class="pl-v">self</span>.output().open(<span class="pl-s"><span class="pl-pds">'</span>w<span class="pl-pds">'</span></span>) <span class="pl-k">as</span> out_file:
            <span class="pl-k">for</span> artist, count <span class="pl-k">in</span> artist_count.iteritems():
                <span class="pl-k">print</span> <span class="pl-k">&gt;&gt;</span> out_file, artist, count</pre></div>

<p>Optimizition notes:</p>

<ol>
<li>luiti's task class is built in with <code>date_value</code> property, and converted
into <code>Arrow</code> data type.</li>
<li>In ArtistStreamDay, <code>date_str</code> is transformed from <code>date_value</code>, and
converted from a function into a instance property after the first call.</li>
<li>
<code>@luigi.ref_tasks</code> bind ArtistStreamDay as AggregateArtistsWeek's
instance property, so we can use <code>self.ArtistStreamDay(d1)</code> form to
instantiate some task instances.</li>
<li>After AggregateArtistsWeek is inherited from <code>TaskWeek</code>, it'll has
<code>self.days_in_week</code> property automatically.</li>
<li>
<code>TargetUtils.line_read</code> replaced original function that needs two
lines codes to complete the feature, and return a Generator directly.</li>
</ol>

<h4>
<a id="writing-mapreduce-in-luiti" class="anchor" href="#writing-mapreduce-in-luiti" aria-hidden="true"><span class="octicon octicon-link"></span></a>Writing MapReduce in luiti</h4>

<ul>
<li>MapReduce file: <code>artist_project/luiti_tasks/aggregate_artists_week.py</code>
</li>
</ul>

<div class="highlight highlight-python"><pre><span class="pl-k">from</span> luiti <span class="pl-k">import</span> <span class="pl-k">*</span>

<span class="pl-en">@</span><span class="pl-en">luigi.ref_tasks</span>(<span class="pl-s"><span class="pl-pds">"</span>ArtistStreamDay')<span class="pl-ii"></span></span>
<span class="pl-k">class</span> <span class="pl-en">AggregateArtistsWeek</span>(<span class="pl-e">TaskWeekHadoop</span>):

    <span class="pl-k">def</span> <span class="pl-en">requires</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> [<span class="pl-v">self</span>.ArtistStreamDay(d1) <span class="pl-k">for</span> d1 <span class="pl-k">in</span> <span class="pl-v">self</span>.days_in_week]

    <span class="pl-k">def</span> <span class="pl-en">output</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> TargetUtils.hdfs(<span class="pl-s"><span class="pl-pds">"</span>/data/weeks/artist_streams_<span class="pl-c1">%s</span>.tsv<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-v">self</span>.date_str

    <span class="pl-k">def</span> <span class="pl-en">mapper</span>(<span class="pl-smi">self</span>, <span class="pl-smi">line1</span>):
        timestamp, artist, <span class="pl-smi">track</span> <span class="pl-k">=</span> line.strip().split()
        <span class="pl-k">yield</span> artist, <span class="pl-c1">1</span>

    <span class="pl-k">def</span> <span class="pl-en">reducer</span>(<span class="pl-smi">self</span>, <span class="pl-smi">artist</span>, <span class="pl-smi">counts</span>):
        <span class="pl-k">yield</span> artist, <span class="pl-c1">len</span>(counts)</pre></div>

<p>Yes, it's almost no difference to luigi, except the <code>self.days_in_week</code>
property and <code>@luigi.ref_tasks</code> decorator.</p>

<h2>
<a id="install" class="anchor" href="#install" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install</h2>

<div class="highlight highlight-bash"><pre>pip install luiti</pre></div>

<p>Or lastest source code</p>

<div class="highlight highlight-bash"><pre>git clone https://github.com/17zuoye/luiti.git
<span class="pl-c1">cd</span> luiti
python setup.py install</pre></div>

<h3>
<a id="time-library" class="anchor" href="#time-library" aria-hidden="true"><span class="octicon octicon-link"></span></a>Time library</h3>

<p>The time library is <a href="http://crsmithdev.com/arrow/">Arrow</a> , every Task
instance's <code>date_value</code> property is a arrow.Arrow type.</p>

<p>luiti will convert date paramters into local time zone automatically. If
you want to customize time, please prefer to use
 <code>ArrowParameter.get(*strs)</code> and <code>ArrowParameter.now()</code> to make sure you
 use the local time zone.</p>

<h3>
<a id="task-recommendation" class="anchor" href="#task-recommendation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Task recommendation</h3>

<h4>
<a id="cache" class="anchor" href="#cache" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cache</h4>

<p>We highly recommend you to use <code>cached_property</code>, like
<a href="http://werkzeug.pocoo.org/docs/0.10/utils/">werkzeug</a> said, "A decorator that
converts a function into a lazy property. The function wrapped is called
the first time to retrieve the result and then that calculated result is
used the next time you access the value".</p>

<p>This function is heavily used in 17zuoye everyday, we use it to cache
lots of things, such as a big data dict.</p>

<div class="highlight highlight-python"><pre><span class="pl-k">class</span> <span class="pl-en">AnotherBussinessDay</span>(<span class="pl-e">TaskDayHadoop</span>):

    <span class="pl-k">def</span> <span class="pl-en">requires</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> [task1, task2, ...]

    <span class="pl-k">def</span> <span class="pl-en">mapper</span>(<span class="pl-smi">self</span>, <span class="pl-smi">line1</span>):
        k1, v1 <span class="pl-k">=</span> process(line1)
        <span class="pl-k">yield</span> k1, v1

    <span class="pl-k">def</span> <span class="pl-en">reducer</span>(<span class="pl-smi">self</span>, <span class="pl-smi">k1</span>, <span class="pl-smi">vs1</span>):
        <span class="pl-k">for</span> v1 <span class="pl-k">in</span> vs1:
            v2 <span class="pl-k">=</span> func2(v1, <span class="pl-v">self</span>.another_dict)
            <span class="pl-k">yield</span> k1, v2

    <span class="pl-en">@cached_property</span>
    <span class="pl-k">def</span> <span class="pl-en">another_dict</span>(<span class="pl-smi">self</span>):
        <span class="pl-c"># lots of cpu/io</span>
        <span class="pl-k">return</span> big_dict</pre></div>

<h4>
<a id="global-utilities" class="anchor" href="#global-utilities" aria-hidden="true"><span class="octicon octicon-link"></span></a>Global utilities.</h4>

<ol>
<li>Basic utilities, such as os, re, json, defaultdict, etc.</li>
<li>Date processing utilities, they are arrow, ArrowParameter.</li>
<li>Cache utilities, <code>cached_property</code>.</li>
<li>Other utilities, such as IOUtils, DateUtils, TargetUtils, HDFSUtils, MRUtils, MathUtils,
 CommandUtils, CompressUtils.</li>
</ol>

<h2>
<a id="task-decorators" class="anchor" href="#task-decorators" aria-hidden="true"><span class="octicon octicon-link"></span></a>Task decorators</h2>

<div class="highlight highlight-python"><pre><span class="pl-c"># 1. Bind related tasks lazily, and can be used as instance property directly.</span>
<span class="pl-en">@</span><span class="pl-en">luigi.ref_tasks</span>(<span class="pl-k">*</span>tasks)

<span class="pl-c"># 2. Support multiple file output in MapReduce</span>
<span class="pl-en">@luigi.multiple_text_files</span>

<span class="pl-c"># 3. Run MapReduce in local mode by only add one decorator.</span>
<span class="pl-en">@</span><span class="pl-en">luigi.mr_local</span>()

<span class="pl-c"># 4. Check current task' data source's date range is satisfied.</span>
<span class="pl-en">@</span><span class="pl-en">luigi.check_date_range</span>()

<span class="pl-c"># 5. Check current task can be runned in current date range.</span>
<span class="pl-en">@</span><span class="pl-en">luigi.check_runtime_range</span>(<span class="pl-smi">hour_num</span><span class="pl-k">=</span>[<span class="pl-c1">4</span>,<span class="pl-c1">5</span>,<span class="pl-c1">6</span>], <span class="pl-smi">weekday_num</span><span class="pl-k">=</span>[<span class="pl-c1">1</span>])

<span class="pl-c"># 6. Bind other output file names except for the default `date_file`, and compacts with cleaning temporary files is the task is failed.</span>
<span class="pl-en">@</span><span class="pl-en">luigi.persist_files</span>(<span class="pl-k">*</span>files)

<span class="pl-k">class</span> <span class="pl-en">AnotherBussinessDay</span>(<span class="pl-e">TaskDayHadoop</span>):
    <span class="pl-k">pass</span></pre></div>

<h2>
<a id="mapreduce-related" class="anchor" href="#mapreduce-related" aria-hidden="true"><span class="octicon octicon-link"></span></a>MapReduce related</h2>

<h4>
<a id="clean-temporary-file-when-a-task-fails" class="anchor" href="#clean-temporary-file-when-a-task-fails" aria-hidden="true"><span class="octicon octicon-link"></span></a>Clean temporary file when a task fails.</h4>

<p>When executing a MR job, luigi will write result to a file with
timestamp instantly. If the task successes, then rename to the name that
the task's original output file path. If the task fails, then YARN will
delete the temporary file automatically.</p>

<h4>
<a id="read-file-in-a-generator-way" class="anchor" href="#read-file-in-a-generator-way" aria-hidden="true"><span class="octicon octicon-link"></span></a>Read file in a Generator way.</h4>

<ol>
<li>Original way. <code>for line1 in TargetUtils.line_read(hdfs1)</code>, <code>line1</code> is an
unicode type.</li>
<li>Read by JSON. <code>for json1 in TargetUtils.json_read(hdfs1)</code>, <code>json1</code> is
a valid Python object.</li>
<li>Read in a K-V format. <code>for k1, v1 in TargetUtils.mr_read(hdfs1)</code>, <code>k1</code>
is an unicode type, and <code>v1</code> is a Python object.</li>
</ol>

<h4>
<a id="hdfs-file-object" class="anchor" href="#hdfs-file-object" aria-hidden="true"><span class="octicon octicon-link"></span></a>HDFS file object</h4>

<p>We recommend to use <code>TargetUtils.hdfs(path1)</code>. This function compacts
with the MR file result data format that consists by "part-00000" file blocks.</p>

<h4>
<a id="mapreduce-test-cases" class="anchor" href="#mapreduce-test-cases" aria-hidden="true"><span class="octicon octicon-link"></span></a>MapReduce test cases</h4>

<ol>
<li>Add MapReduce input and output to <code>mrtest_input</code> and <code>mrtest_output</code>,
these mimic the MapReduce processing.</li>
<li>In your test file, use <code>@MrTestCase</code> to decorator your test class,
and add your task class to <code>mr_task_names</code> list.</li>
<li>(Optional) Add some config dict to <code>mrtest_attrs</code> to mimic properties
that generated in production mode.</li>
<li>Run your test cases!</li>
</ol>

<p>buy_fruit_day.py</p>

<div class="highlight highlight-python"><pre><span class="pl-k">from</span> luiti <span class="pl-k">import</span> <span class="pl-k">*</span>

<span class="pl-k">class</span> <span class="pl-en">BuyFruitDay</span>(<span class="pl-e">TaskDayHadoop</span>):

    <span class="pl-k">def</span> <span class="pl-en">requries</span>(<span class="pl-smi">self</span>):
        ...

    <span class="pl-k">def</span> <span class="pl-en">output</span>(<span class="pl-smi">self</span>):
        ...

    <span class="pl-k">def</span> <span class="pl-en">mapper</span>(<span class="pl-smi">self</span>, <span class="pl-smi">line</span>):
        ...
        <span class="pl-k">yield</span> uid, fruit

    <span class="pl-k">def</span> <span class="pl-en">reducer</span>(<span class="pl-smi">self</span>, <span class="pl-smi">uid</span>, <span class="pl-smi">fruits</span>):
        price <span class="pl-k">=</span> <span class="pl-c1">sum</span>([<span class="pl-v">self</span>.price_dict[fruit] <span class="pl-k">for</span> fruit <span class="pl-k">in</span> fruits])
        <span class="pl-k">yield</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, MRUtils.str_dump({<span class="pl-s"><span class="pl-pds">"</span>uid<span class="pl-pds">"</span></span>: uid, <span class="pl-s"><span class="pl-pds">"</span>price<span class="pl-pds">"</span></span>: price})

    <span class="pl-en">@cache_property</span>
    <span class="pl-k">def</span> <span class="pl-en">price_dict</span>(<span class="pl-smi">self</span>):
        result <span class="pl-k">=</span> <span class="pl-c1">dict</span>()
        <span class="pl-k">for</span> json1 <span class="pl-k">in</span> TargetUtils.json_read(a_fruit_price_list_file):
            result[json1[<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>]] <span class="pl-k">=</span> json1[<span class="pl-s"><span class="pl-pds">"</span>price<span class="pl-pds">"</span></span>]
        <span class="pl-k">return</span> result

    <span class="pl-k">def</span> <span class="pl-en">mrtest_input</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">{"uid": 3, "fruit": "Apple"}</span>
<span class="pl-s">{"uid": 3, "fruit": "Apple"}</span>
<span class="pl-s">{"uid": 3, "fruit": "Banana"}</span>
<span class="pl-s">        <span class="pl-pds">"""</span></span>

    <span class="pl-k">def</span> <span class="pl-en">mrtest_output</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">{"uid": 3, "price": 7}</span>
<span class="pl-s">        <span class="pl-pds">"""</span></span>

    <span class="pl-k">def</span> <span class="pl-en">mrtest_attrs</span>(<span class="pl-smi">self</span>):
        <span class="pl-k">return</span> {
          <span class="pl-s"><span class="pl-pds">"</span>price_dict<span class="pl-pds">"</span></span>: {
            <span class="pl-s"><span class="pl-pds">"</span>Apple<span class="pl-pds">"</span></span>: <span class="pl-c1">3</span>,
            <span class="pl-s"><span class="pl-pds">"</span>Banana<span class="pl-pds">"</span></span>: <span class="pl-c1">1</span>,
          }
        }
</pre></div>

<p>test file</p>

<div class="highlight highlight-python"><pre><span class="pl-k">from</span> luiti <span class="pl-k">import</span> MrTestCase

<span class="pl-en">@MrTestCase</span>
<span class="pl-k">class</span> <span class="pl-en">TestMapReduce</span>(<span class="pl-e">unittest.TestCase</span>):
    mr_task_names <span class="pl-k">=</span> [
            <span class="pl-s"><span class="pl-pds">'</span>ClassEnglishAllExamWeek<span class="pl-pds">'</span></span>,
            ...
           ]

<span class="pl-k">if</span> <span class="pl-c1">__name__</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>__main__<span class="pl-pds">'</span></span>:
  unittest.main()</pre></div>

<h2>
<a id="extend-luiti" class="anchor" href="#extend-luiti" aria-hidden="true"><span class="octicon octicon-link"></span></a>Extend luiti</h2>

<p>Using <code>TaskBase</code>'s builtin <code>extend</code> class function to extend or overwrite
the default properties or functions, for example:</p>

<div class="highlight highlight-python"><pre>TaskWeek.extend({
    <span class="pl-s"><span class="pl-pds">'</span>property_1<span class="pl-pds">'</span></span> : <span class="pl-k">lambda</span> <span class="pl-smi">self</span>: <span class="pl-s"><span class="pl-pds">"</span>property_2<span class="pl-pds">"</span></span>,
})</pre></div>

<p><code>extend</code> class function compacts with <code>function</code>, <code>property</code>, <code>cached_property</code>,
or any other attributes at the same time。When you want to overwrite
<code>property</code> and <code>cached_property</code>, you just need a function value, and
<code>extend</code> will automatically converted into <code>property</code> and
<code>cached_property</code> type.</p>

<h2>
<a id="faq" class="anchor" href="#faq" aria-hidden="true"><span class="octicon octicon-link"></span></a>FAQ</h2>

<p>Q: How atomic file is supported?</p>

<p>A: As luigi's document mentioned that "Simple class that writes to a temp file and moves it on close()
    Also cleans up the temp file if close is not invoked", so use the <code>self.input().open("r")</code> or
    <code>self.output().open("w")</code> instead of <code>open("some_file", "w")</code>.</p>

<p>Q: Can luigi detect the interdependent tasks?</p>

<p>A: It's not question inside of luigi, but it's a question about <a href="https://en.wikipedia.org/wiki/Topological_sorting">topological sorting</a>
   as a general computer science topic. The task scheduler is implemented at <code>luigi/scheduler.py</code> .</p>

<p>Q: How to pass more parameters into luiti tasks?</p>

<p>A: You can create a key-value dict, <code>date_value</code> is the key, and your
customize parameters are the values.</p>

<p>If you have other unresolved questions, please feel free to ask
questions at <a href="https://github.com/17zuoye/luiti/issues">issues</a>.</p>

<h2>
<a id="run-tests" class="anchor" href="#run-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run tests</h2>

<div class="highlight highlight-bash"><pre>nosetests</pre></div>

<h2>
<a id="who-uses-luiti" class="anchor" href="#who-uses-luiti" aria-hidden="true"><span class="octicon octicon-link"></span></a>Who uses Luiti?</h2>

<ul>
<li>
<a href="http://www.17zuoye.com/">17zuoye</a> Luiti born at this company.</li>
</ul>

<p>Please let us know if your company wants to be featured on this list!</p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>MIT. David Chen @ 17zuoye.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/17zuoye/luiti">Luiti</a> is maintained by <a href="https://github.com/17zuoye">17zuoye</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-57207964-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>

